# Genesis v1 스펙 (Workspace / UI / 저장 / 광고 힌트)

## 0) 목표
- 모바일(Phone/Pad) 조합 퍼즐 게임의 v1 구현 스펙 정의
- 로그인 없이 로컬 저장만 사용
- 광고는 AdMob 보상형(Rewarded)만 사용 (배너는 v2 이후)

---

## 1) 핵심 규칙

### 1.1 조합
- 조합 결과는 항상 **단일 요소 1개**만 생성한다.
- 입력 순서는 무관하다. `A+B == B+A`
- 조합 성공 시: 입력 2개 인스턴스는 제거되고 결과 1개 인스턴스가 생성된다. (총 -1)
- 조합 실패(레시피 없음) 시: 아무 변화 없음(단, 약한 실패 피드백은 제공 가능)

### 1.2 생성(편의 기능)
- **빈 공간 더블탭**: 탭 좌표 기준으로 기본 4요소가 동서남북에 생성된다.
- **요소 더블탭**: 해당 요소가 복제되어 원본 주변의 가장 가까운 유효 위치에 1개 생성된다.

---

## 2) UI 레이아웃

### 2.1 12버튼 바(고정 UI)
- 총 12개의 버튼이 나열되어 있다.
- Phone(세로로 긴 휴대폰): **좌측 세로 바**
- Pad(세로로 긴 패드): **하단 가로 바**

버튼 구성(순서 고정):
1) 도감(Compendium)
2~11) 퀵드로우(즐겨찾기 10칸)
12) 도움말(Help)

> 퀵드로우는 “즐겨찾기 요소를 도감 없이 바로 꺼내쓰기” 메뉴다.

### 2.2 UI 모드 전환(중요)
- `NORMAL`: 12버튼 바 표시
- `DRAGGING`: 12버튼 바 숨김, 해당 영역 전체가 **휴지통 Drop Zone**으로 전환

---

## 3) 제스처 및 입력 우선순위

### 3.1 파라미터(권장, DP 기반)
- `DOUBLE_TAP_TIME_MS = 280`
- `TAP_SLOP_DP = 10`
- `DRAG_START_DP = 12`

### 3.2 우선순위 규칙
1) 포인터 이동량이 `DRAG_START_DP`를 넘으면 즉시 드래그 우선
2) 드래그로 전이된 시퀀스는 더블탭 후보에서 제외
3) 더블탭은 동일 대상(빈 공간 또는 같은 인스턴스) + 시간/거리 조건 충족 시만 인정

### 3.3 조합 트리거
- 조합은 **드래그 종료(드롭) 시점**에만 발생한다.
- 드롭 위치에서 타겟 요소 히트 테스트가 성공하면 조합을 시도한다.
- 드래그 중 “근접”만으로 자동 합성되지 않는다.

---

## 4) 스폰/배치(nearby placement)

### 4.1 공통 개념
- 요소는 원형 점유 반경 `R`을 가진다고 가정
- 최소 간격: `MIN_GAP = 2R + SAFE_MARGIN`

### 4.2 기본 스폰 거리
- `BASE_SPAWN_RADIUS`
  - Phone: `max(56dp, 2.4R)`
  - Pad: `max(72dp, 2.8R)`

### 4.3 빈 공간 더블탭(4요소 배치)
- 기준점 `C(x,y)`에서 동서남북 후보 좌표 생성 후, 각 후보는 nearby placement로 보정한다.
- 방향-원소 매핑(고정):
  - N(위): 불
  - E(오른쪽): 물
  - S(아래): 바람
  - W(왼쪽): 땅
- 수량 제한으로 4개를 다 못 만들 경우 우선순위는 위 순서를 따른다(N→E→S→W).

### 4.4 요소 더블탭(복제 배치)
- 원본 중심에서 가장 가까운 빈 좌표 탐색
- 각도: `0°,45°,90°...315°`
- 반경 확장: `d, d+step, ... d_max`
  - `step = max(12dp, 0.5R)`
  - `d_max = 3.5 * BASE_SPAWN_RADIUS`
- 최초로 유효한 좌표를 선택(거리 최소, 동률 시 각도 우선순위 고정)

### 4.5 유효성 조건
후보 좌표 P가 유효하려면:
1) 화면/월드 경계 내부(요소 반경 포함)
2) 기존 요소와 중심거리 `>= MIN_GAP`

> MVP에서는 “최종 위치 충돌”만 검사한다. (애니메이션 경로 충돌 검사는 v2 옵션)

---

## 5) 캔버스 수량 제한

### 5.1 기본 값
- Phone: `MAX_ELEMENTS_ON_CANVAS = 80`
- Pad: `MAX_ELEMENTS_ON_CANVAS = 120`

### 5.2 액션별 처리
- 빈 공간 더블탭(4개 생성):
  - 남은 슬롯 `remain`
  - `remain <= 0`: 전체 실패
  - `remain > 0`: `min(4, remain)`개까지만 시도 (부분 성공 허용)
- 요소 더블탭(복제 1개):
  - `remain <= 0`이면 즉시 실패
- 조합 성공:
  - 입력 2개 제거 + 결과 1개 생성 → 슬롯 상 항상 유리(-1)
  - 단, 결과 배치 실패 시 조합 롤백(입력 복원)

---

## 6) 드래그 중 삭제 UX (Trash Drop Zone)

### 6.1 UI 전환
- 드래그 시작 시(`Dragging` 진입):
  - UI 모드 `NORMAL → DRAGGING`
  - 12버튼 바 숨김
  - 동일 영역 전체가 **휴지통 Drop Zone**으로 표시

### 6.2 삭제 판정
- 드래그 종료 시, 드롭 포인트(또는 드래그 중 요소 중심)가 Drop Zone 내부면:
  - 해당 `ElementInstance` 즉시 삭제
- 삭제는 크리티컬하지 않으므로 Undo/지연 활성화는 적용하지 않는다.

### 6.3 피드백(권장)
- Drop Zone 위로 진입 시 하이라이트 + “놓으면 삭제” 짧은 안내(선택)
- 삭제 시 짧은 축소/페이드 애니메이션(150~200ms)

---

## 7) 도감(Compendium) & 즐겨찾기(QuickDraw)

### 7.1 도감 표시 규칙
- 도감에는 다음 요소가 표시된다:
  - `discoveredByDefault == true` (기본 4요소 포함)
  - 또는 `definitionId ∈ discoveredByCombine` (조합으로 발견한 요소)
- 정렬: `ElementDefinition.id` 오름차순(식별번호/문자열 기준)

### 7.2 도감에서 즉시 소환
- 도감 리스트의 “워크스페이스에 배치” 버튼 탭:
  1) 도감 닫힘
  2) 해당 요소 1개 생성 시도
  3) 생성 위치 우선순위:
     - `lastWorkspaceTapPoint` 주변 nearby placement
     - fallback: 화면 중앙 주변 nearby placement

### 7.3 즐겨찾기(최대 10개)
- 즐겨찾기 대상:
  - `discoveredByDefault ∪ discoveredByCombine`
- 중복 추가 금지, 최대 10개
- 즐겨찾기 설정은 도감에서 `☆/★` 토글로 관리

### 7.4 퀵드로우(2~11번 버튼)
- 퀵드로우 버튼 탭 시 해당 요소 1개를 즉시 생성한다.
- 생성 규칙은 도감 즉시 소환과 동일(nearby placement).
- DRAGGING 모드에서는 퀵드로우 UI가 표시되지 않는다.

---

## 8) 도움말(Help) + 광고 힌트(Rewarded)

### 8.1 도움말
- 조작 설명:
  - 빈 공간 더블탭: 기본 4요소 생성
  - 요소 더블탭: 복제
  - 드래그/드롭: 조합
  - 드래그 중 휴지통 영역 드롭: 삭제

### 8.2 힌트 보기(AdMob Rewarded)
- 힌트는 도움말에서만 제공된다.
- 광고 타입: **AdMob Rewarded**
- 제한: **하루 최대 3회**
- 카운트 기준:
  - Rewarded의 리워드 지급 이벤트(시청 완료) 성공 시에만 1회 차감/증가
  - 로딩 실패/닫힘/실패는 카운트하지 않는다.
- 배너 광고는 v1에서 사용하지 않는다(향후 추가 여지).

### 8.3 힌트 내용 정의
- “현재 발견하지 못한 조합” 중에서,
- “내가 이미 가진 요소들(발견한 요소들)로 가능한 조합” 1개를 보여준다.

정확한 정의:
- 레시피 `a+b=result`에 대해,
  - `result`가 아직 미발견이고,
  - `a`와 `b`는 이미 발견되어 있으면 후보
- 후보 중 1개를 선택하여 완전 공개 형태로 제시:
  - 예: `불 + 물 = 수증기`

---

## 9) 저장(로컬) 및 재실행 복원

### 9.1 요구사항
- 앱 재실행 시 워크스페이스(캔버스)는 **마지막 상태 그대로 복원**되어야 한다.

### 9.2 저장 데이터
- `canvas.instances`: ElementInstance 배열
- `collection.discoveredByCombine`: Set (저장 시 배열로 직렬화)
- `collection.favorites`: definitionId 배열 (max 10)
- `ui.lastWorkspaceTapPoint`: 마지막 탭 좌표
- `adHint`: 힌트 광고 사용량(일 3회)

### 9.3 좌표 저장 방식(권장)
- 화면 크기 변경에 대응하기 위해 인스턴스 좌표는 workspace 상대좌표(0~1)로 저장:
  - `xNorm = x / workspaceWidth`
  - `yNorm = y / workspaceHeight`
- 로드 시:
  - `x = xNorm * workspaceWidth`
  - `y = yNorm * workspaceHeight`

### 9.4 저장 타이밍(권장)
- 변경 이벤트 발생 시 300~800ms 디바운스 저장
- 앱이 background로 전환될 때 강제 저장 1회

### 9.5 힌트 사용량 로컬 저장 포맷
```json
{
  "adHint": {
    "date": "YYYY-MM-DD",
    "used": 0,
    "limit": 3
  }
}
```

---

## 10) 데이터 모델 (ElementDefinition vs ElementInstance)

### 10.1 ElementDefinition
- 정적 메타 데이터
- 예시 필드:
  - `id: string`
  - `name: string`
  - `icon: string`
  - `discoveredByDefault: boolean`

### 10.2 ElementInstance
- 캔버스 상 실제 인스턴스
- 예시 필드:
  - `instanceId: string`
  - `definitionId: string`
  - `positionNorm: { x: number, y: number }`
  - `state: 'idle' | 'dragging'`

### 10.3 UserCollectionState
- `discoveredByCombine: definitionId[]`
- `favorites: definitionId[]` (max 10)

### 10.4 조합 키 정규화
- 순서 무관 조합 보장을 위해:
  - `comboKey = sort([defIdA, defIdB]).join('+')`

---

## 11) 이벤트/로깅 (권장)
- `workspace_double_tap_empty {x, y, spawnedCount, failReason?}`
- `workspace_double_tap_element {instanceId, spawned, failReason?}`
- `combine_attempt {aDef, bDef, comboKey, success, failReason?}`
- `compendium_open {visibleCount}`
- `quickdraw_spawn {slotIndex, definitionId, success, failReason?}`
- `help_hint_rewarded {loaded, watched, rewarded, failReason?}`

---

## 12) 수용 기준 (Acceptance Criteria)
1. `A+B`와 `B+A`는 항상 동일 결과를 생성한다.
2. 조합 결과는 항상 1개이며, 성공 시 입력 2개는 제거되고 결과 1개가 생성된다.
3. 빈 공간 더블탭 시 기본 4요소가 N/E/S/W 매핑과 우선순위를 따라 생성된다.
4. 더블탭 복제/퀵드로우/도감 소환은 nearby placement 규칙을 공통으로 사용한다.
5. DRAGGING 모드 진입 시 12버튼 바는 숨겨지고 동일 영역은 휴지통 Drop Zone으로 동작한다.
6. 도감/퀵드로우 대상 요소 및 최대 10개 즐겨찾기 제약이 준수된다.
7. 힌트는 Rewarded 성공 시에만 일일 3회 한도에서 카운트된다.
8. 앱 재실행 시 캔버스/발견/즐겨찾기/힌트 사용량이 로컬 저장에서 복원된다.
